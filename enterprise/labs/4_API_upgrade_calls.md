# CM Lab

# Upgrade Cloudera Manager

Upgrade to the latest C5.9 release
Use the documentation here
Use the API on the command line to:
Report the latest available version of the API
Report the CM version
List all CM users
Report the database server in use by CM
Add these API calls and their output to enterprise/labs/4_API_upgrade_calls.md

https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ag_ug_cm5.html

## Step 1: Collect Upgrade Information

### The version of Cloudera Manager used in your cluster
Version: Cloudera Enterprise Data Hub Edition Trial 5.11.0 (#101 built by jenkins on 20170412-1255 git: 70cb1442626406432a6e7af5bdf206a384ca3f98)

### The version of the JDK deployed in the cluster
Java VM Name: Java HotSpot(TM) 64-Bit Server VM

Java VM Vendor: Oracle Corporation

Java Version: 1.7.0_67

Server Time: May 4, 2017 2:42:17 AM, Eastern Daylight Time (EDT)

Copyright © 2011-2017 Cloudera, Inc. All rights reserved.
Hadoop and the Hadoop elephant logo are trademarks of the Apache Software Foundation.

### The version of CDH. The CDH version number displays next to the cluster name on the Home page.
 Cluster 1  (CDH 5.11.0, Parcels)
 
### Whether the cluster was installed using parcels or packages. This information displays next to the CDH version on the Home page of Cloudera Manager.
 Cluster 1  (CDH 5.11.0, Parcels)
 
### The services enabled in your cluster. Go to Clusters > Cluster name.

 Hosts	  		
 HDFS	
 Hive	  		
 Hue	  		
 Oozie	  		
 YARN (MR2 Included)
 ZooKeeper	 
 
### Operating system type and version. Go to Hosts and click on a hostname in the list. The operating system type and version displays in the Distribution row in the Details section.
Distribution	redhat 7.3


## Step 2: Complete Pre-Upgrade Steps

 
## Step 3: Back Up Cloudera Manager Databases
Stop the Cloudera Management Service:
Select Clusters > Cloudera Management Service.
Select Actions > Stop.


Back up the following Cloudera Manager databases:
Cloudera Manager Server
Cloudera Navigator Audit Server
Cloudera Navigator Metadata Server
Activity Monitor
Reports Manager

$ more /etc/cloudera-scm-server/db.properties 
# Auto-generated by scm_prepare_database.sh on Tue May  2 08:31:11 EDT 2017
#
# For information describing how to configure the Cloudera Manager Server
# to connect to databases, see the "Cloudera Manager Installation Guide."
#
com.cloudera.cmf.db.type=mysql
com.cloudera.cmf.db.host=localhost
com.cloudera.cmf.db.name=hue
com.cloudera.cmf.db.user=hue
com.cloudera.cmf.db.setupType=EXTERNAL
com.cloudera.cmf.db.password=huepassword

For the other databases, go to Clusters > Cloudera Management Service > Configuration and select the Database category. 
You might need to contact your database administrator to obtain passwords.

Backing Up MySQL Databases
To back up the MySQL database, run the mysqldump command on the MySQL host, as follows:
$ mysqldump -hhostname -uusername -ppassword database > /tmp/database-backup.sql
For example, to back up the Activity Monitor database amon created in Creating Databases for Activity Monitor, Reports Manager, Hive Metastore Server, Sentry Server, Cloudera Navigator Audit Server, and Cloudera Navigator Metadata Server, on the local host as the root user, with the password amon_password:
$ mysqldump -pamon_password amon > /tmp/amon-backup.sql
To back up the sample Activity Monitor database amon on remote host myhost.example.com as the root user, with the password amon_password:
$ mysqldump -hmyhost.example.com -uroot -pcloudera amon > /tmp/amon-backup.sql



Start the Cloudera Management Service:
Select Clusters > Cloudera Management Service.
Select Actions > Start.


## Step 4: Upgrade the JDK
If your Cloudera Manager hosts use an unsupported version of the JDK, you must upgrade the hosts to a supported version of the JDK before upgrading Cloudera Manager. 
If you plan to upgrade CDH, you must also upgrade the JDK on all cluster hosts.


## Step 5: Establish Access to the Software
If the Cloudera Manager host does not have access to the internet, or you install a version lower than the latest version of Cloudera Manager, configure access to the Cloudera Manager software from either the Cloudera public repository or a local package repository that you create.

## Step 6: Prepare the Cloudera Navigator Data Management Component for Upgrade


## Step 7: Upgrade the Cloudera Manager Server

Auditing:
Cluster 1 > HDFS (Service-Wide)
Cluster 1 > Hive (Service-Wide)
Cluster 1 > Hue (Service-Wide)
Cloudera Management Service > Navigator Metadata Server Default Group 



Stop the Cloudera Management Service:
Select Clusters > Cloudera Management Service.
Select Actions > Stop.


On the host running the Cloudera Manager Server, stop the Cloudera Manager Server:
$ sudo service cloudera-scm-server stop


If the Cloudera Manager host is also running the Cloudera Manager Agent, stop the Cloudera Manager Agent:
$ sudo service cloudera-scm-agent stop


Back up the following directories on the Cloudera Manager server host:
mkdir /etc/cloudera-scm-server.backup
cp -r /etc/cloudera-scm-server/* /etc/cloudera-scm-server.backup
mkdir /etc/cloudera-scm-agent.backup
cp -r /etc/cloudera-scm-agent /etc/cloudera-scm-agent.backup

Back up the current Cloudera Manager repo file, located in one of the following directories:
mkdir /etc/yum.repos.d.backup
cp -r /etc/yum.repos.d/* /etc/yum.repos.d.backup



Use the following command to download the .repo file for Cloudera Manager version 5 and RHEL version 6:
$ wget https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/cloudera-manager.repo

Upgrade to the most recent version of Cloudera Manager:
cp cloudera-manager.repo /etc/yum.repos.d/


Upgrade to an specific version of Cloudera Manager:
Edit the cloudera-manager.repo file to change the baseurl to point to the version of Cloudera Manager you want to download.
vi cloudera-manager.repo
baseurl=https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.9/



Run the following command to clean the cache directories and upgrade the software:
sudo yum clean all
sudo yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent


If you customized the /etc/cloudera-scm-agent/config.ini file, your customized file is renamed with the extension .rpmsave or .dpkg-old. 
Merge any customizations into the /etc/cloudera-scm-agent/config.ini file that is installed by the package manager.


On the Cloudera Manager Server host, verify that you now have the following packages, corresponding to the version of Cloudera Manager you installed, by running the following command:
$ rpm -qa 'cloudera-manager-*'
cloudera-manager-agent-5.11.0-1.cm5110.p0.101.el7.x86_64
cloudera-manager-daemons-5.11.0-1.cm5110.p0.101.el7.x86_64
cloudera-manager-server-5.11.0-1.cm5110.p0.101.el7.x86_64

Start Cloudera Manager Server. 
On the Cloudera Manager Server host (the host on which you installed the cloudera-manager-server package), do the following:

Start the Cloudera Manager Server:
$ sudo service cloudera-scm-server start

Log in to the Cloudera Manager Admin Console. 
It can take several minutes for Cloudera Manager Server to start, and the console is unavailable until the server startup is complete.
The Upgrade Wizard displays.

http://ec2-54-191-132-13.us-west-2.compute.amazonaws.com:7180/

admin / cloudera



Upgrade the Cloudera Manager Agent using Cloudera Manager or by manually upgrading the packages:







sudo service cloudera-scm-agent start









